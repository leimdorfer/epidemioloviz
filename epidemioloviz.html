
<!DOCTYPE html>
<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <style>
    body {
        background:#b5d0d0;
        font-family:Arial;
    }
    .h1 {
        color:#285585;
        padding: 10px
    }

    #container {
        margin:20px;
        position: relative;
    }
    #container:after {
      content: "";
      display: table;
      clear: both;
    }

    #experiment {
        float:left;
    }

    #controls {
        margin:5px;
    }

    #viz {
        border-radius:.125em;
        border:2px solid #ccc;   
        background:white;
        width:800px;
        height:400px;
        position: relative;
    }

    #analysis {
        float:left;
    }

    #chart {
        border-left:2px solid #333;
        border-bottom:2px solid #333;
        margin:5px;   
        width:240px;
        height:400px;
        position: relative;
    }

    .person {
        display: block;
        width:5px;
        height:5px;
        position: absolute;
    }
    .uninfected {
        background:darkgray;
    }
    .infected {
        background:red;
    }
    .imune {
        background:green;
    }

    .datapoint{
        display: block;
        width:1px;
        height:1px;
        position: absolute;
        top:399px;
        background:red;
    }

  
    </style>
</head>

<body>

    <h1>My epidemic visualisation</h1>

<div id="container">

    <div id="experiment">

        <div id="controls">
            <button onclick="doAnimation();">Start Infection</button> <br>
        </div>
        <div id="viz"></div>

    </div>


    <div id="analysis">

        Total infections: <span id="infections_count">0</span>

        <div id="chart">
            <div class="datapoint"></div>
        </div>

    </div>

</div>

	<script>

        function init(){

            // Some Globals
            // set limit of position within viz
            max_width = document.getElementById("viz").clientWidth-5;
            max_height = document.getElementById("viz").clientHeight-5;

            number_of_people = 400;
            start_infected = 1;
            infectiousness = 4;
            animation_duration = 10000;
            stay_at_home = 0;

            animation_count = 0;
            total_infected = start_infected; // This goes up as people get infected
            infections_count = document.getElementById('infections_count');
            analysis_count = 0; //counts each time we run display_analysis

            // This is the array where we store the infected count per animation
            //total_infected_over_time = []; Not needed?

            

            // This is the array where we store the people objects
            people = [];

            createPeople();
            distributePeople();
            infectPeople();
            setMovement();

        }



        function createPeople() {

            for(var i=0;i<number_of_people;i++){

                // Create a <div> element
                var person = document.createElement("div"); 
                // Append person to <div> with id="viz" 
                document.getElementById("viz").appendChild(person); 
                // Get element in the document
                var new_person = document.getElementById('viz').getElementsByTagName('div')[i];  
                var element_class = document.createAttribute("class");  // add "class" attribute
                element_class.value = "person uninfected";                 // Set value of class
                new_person.setAttributeNode(element_class);

                // create object for each person with default values and add to people array
                people.push({
                    element: document.getElementById('viz').getElementsByTagName('div')[i],
                    class:"uninfected", 
                    move_x:0, 
                    move_y:0,
                    left:0,
                    top:0
                });

            }

        };

        function distributePeople(){

            // Set a random starting point for each person
            for(var i=0;i<number_of_people;i++){

                var start_x = Math.floor(Math.random() * max_width);
                var start_y = Math.floor(Math.random() * max_height);

                people[i].left = start_x;
                people[i].top = start_y;

                // the element is in the object in the people array
                var this_person = people[i].element;

                this_person.style.left=start_x+"px";
                this_person.style.top=start_y+"px";
            }
        };

        function infectPeople(){

            for(var i=0;i<start_infected;i++){

                people[i].element.classList.toggle("infected");
                people[i].class="infected";

            }

        };

        function setMovement(){

            // Set a random movement for x and y for each person -1,0 or 1
            for(var i=0;i<number_of_people;i++){

                var move_x = Math.floor(Math.random() * 3);
                var move_y = Math.floor(Math.random() * 3);

                if(move_x===2) move_x = -1; 
                if(move_y===2) move_y = -1; 


                people[i].move_x = move_x;
                people[i].move_y = move_y;

                // Add stay_at_home variable

            }
        };

        function doAnimation(){

            var startTime = new Date().getTime();
            var interval = setInterval(function(){
                if(new Date().getTime() - startTime > animation_duration){
                    clearInterval(interval);
                    return;
                }
                //do animation
                animatePeople()

            }, 10);

        };

        function animatePeople(){
            
            animation_count++;
            if(animation_count%75===0) setMovement();

            // Move each person x and y.
            for(var i=0;i<number_of_people;i++){

                // the element is in the object in the people array
                var this_person = people[i].element;

                var next_x = people[i].left+people[i].move_x;
                var next_y = people[i].top+people[i].move_y;

                people[i].left = next_x;
                people[i].top = next_y;

                this_person.style.left=next_x+"px";
                this_person.style.top=next_y+"px";

                checkLimits(i,next_x,next_y);
            }

            checkCollisions();

            // Every 200 milliseconds do some analysis
            if(animation_count%20===0) {
                analysis_count++;
                display_analysis();
            }
         
        };

        function checkLimits(id,x,y){

            // Bounce off the walls
            if(x>max_width) people[id].move_x=-1;
            if(x<5) people[id].move_x=1;
            if(y>max_height) people[id].move_y=-1;
            if(y<0) people[id].move_y=1;

        };

        function checkCollisions(){

            var this_infection_count=0;

            for(var i=0;i<number_of_people;i++){

                var this_x = people[i].left;
                var this_y = people[i].top;

                // If your infected or immune you don't get infected again
                if (people[i].class==="uninfected"){ 

                    for(var j=0;j<number_of_people;j++){
                        //If to people collide and one is infected the other gets infected
                        if( (this_x-people[j].left)<infectiousness && 
                            (this_x-people[j].left)>-infectiousness &&
                            (this_y-people[j].top)<infectiousness && 
                            (this_y-people[j].top)>-infectiousness && 
                            i!=j &&
                            people[j].class==="infected"
                        ){
                        
                            people[i].element.classList.toggle("infected");
                            people[i].class="infected";
                            this_infection_count++;
                        }

                    }

                }
            }

            total_infected = total_infected+this_infection_count;

        };

        function display_analysis(){

            // Display total infections
            infections_count.innerHTML = total_infected;

            // Create a <div> element
            var datapoint = document.createElement("div");

            datapoint.setAttribute("class", "datapoint");
            document.getElementById("chart").appendChild(datapoint);

            var this_point = document.getElementById("chart").getElementsByTagName("div")[analysis_count];

            this_point.style.left=(analysis_count)+"px"; //move left with time
            this_point.style.top=(400-(total_infected))+"px";
            this_point.style.height=(total_infected)+"px";



        }

        init();



</script>


</body>
</html>
